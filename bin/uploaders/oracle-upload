#!/bin/bash

DB_NAME=${1}
EXTRACT_NAME=${2}
PROCESS_DIR=${3}
UPLOADS_DIR=${4}

CTL_FILE=${PROCESS_DIR}/${EXTRACT_NAME}.ctl
DAT_FILE=${PROCESS_DIR}/${EXTRACT_NAME}.dat
SQL_FILE=${PROCESS_DIR}/${EXTRACT_NAME}.sql
LOG_FILE=${UPLOADS_DIR}/${EXTRACT_NAME}.txt
BAD_FILE=${UPLOADS_DIR}/${EXTRACT_NAME}.bad.txt
DIS_FILE=${UPLOADS_DIR}/${EXTRACT_NAME}.discard.txt

# Create named pipe for uncompressed data file
mknod ${DAT_FILE} p
gzip -dc ${DAT_FILE}.gz > ${DAT_FILE} &

# Execute SQL*Loader. Credentials are configured in Oracle Wallet.
sqlldr \
  direct=true \
  control="${CTL_FILE}" \
  log="${LOG_FILE}" \
  bad="${BAD_FILE}" \
  discard="${DIS_FILE}" \
  errors=10000 \
  date_cache=0 \
  userid=/@${DB_NAME} \
  data="${DAT_FILE}"

# Execute SQL file
sqlplus /@${DB_NAME} @"${SQL_FILE}"

# Remove named pipe
rm -f ${DAT_FILE}
